<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>biop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root{
      --hijau-tua: #064e3b;
      --hijau: #22c55e;
      --biru: #0ea5e9;
      --biru-tua: #1d4ed8;
      --hijau-muda: #bbf7d0;
      --emas: #facc15;
      --putih-transparan: rgb(255,255,255);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      background: black;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 4px;
      color: black;
    }

    .app-container {
      width: 100%;
      max-width: 480px;
      border-radius: 2px;
      border: 2px solid var(--emas);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      overflow: hidden;
      position: relative;
      background: #E8EBEA;
    }

    .pad-input { padding: 22px 20px 18px; }
    .pad-report { padding: 10px 2px 2px; }
    .page { display: none; }
    .page.active { display: block; }

    .rekap-title {
      text-align: center;
      font-size: 24px;
      font-weight: 800;
      letter-spacing: 0.06em;
      color: #000000;
      margin-bottom: 26px;
      text-transform: uppercase;
      text-shadow: none;
    }

    #page-input { font-size: 16px; color: black; }

    .btn-back-page {
      background: linear-gradient(to right, #90EE90, #008000,#008000, #008000,#008000, #008000, #90EE90);
      color: white;
      width: 90%;
      padding: 12px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 16px;
      margin: 2px auto 10px;
      cursor: pointer;
      text-align: center;
      border: 6px solid var(--emas);
      display: block;
    }
    .btn-back-page:hover {
      transform: translateY(-1px);
    }
    .btn-back-page:active {
      transform: translateY(1px);
    }

    .btn {
      border: 3px solid var(--emas);
      padding: 14px;
      border-radius: 14px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      background: #008000;
      color: white;
    }

    .btn-row {
      display: flex;
      gap: 10px;
      margin-top: 14px;
    }

    .btn-primary { flex: 4; }
    .btn-secondary { flex: 1; }

    .btn:hover {
      transform: translateY(-1px);
    }
    .btn:active {
      transform: translateY(1px);
    }

    .form-group { margin-bottom: 14px; }

    label {
      font-size: 16px;
      margin-bottom: 4px;
      display: block;
      color: #000000;
      font-weight: 600;
      text-shadow: none;
    }

    /* Label di sebelah kiri textbox Tanggal & Keterangan (selalu horizontal) */
    .form-row {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 10px;
    }

    .form-row label {
      margin-bottom: 0;
      min-width: 90px;
      text-align: left;
      white-space: nowrap;
    }

    .form-row input {
      flex: 1;
    }

    input[type="date"],
    input[type="text"],
    input[type="tel"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 15px;
      border: 2px solid var(--emas);
      outline: none;
      background: #ffffff;         /* kotak isian putih */
      color: #111827;
    }

    input::placeholder {
      color: black;
    }

    input:focus {
      border-color: black;
    }

    .amount-wrapper {
      background: none;
      border: 2px solid var(--emas);
      border-radius: 16px;
      padding: 10px;
      display: flex;
      gap: 8px;
    }

    .amount-field { flex: 1; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 11px;
      border: 1px solid var(--emas);
      background: white;
      color: black;
    }

    th, td {
      padding: 4px 5px;
      border: 1px solid var(--emas);
      background: none;
    }

    th {
      font-weight: 700;
    }

    tr:nth-child(even) td {
      background: #E0FFFF; /* hilangkan background baris genap */
    }

    tr:hover td {
      background: none; /* hilangkan background hover */
      transition: background 0.18s ease;
    }

    .text-right { text-align:right; }

    .col-tgl {
      width: 1%;
      white-space: nowrap;
    }
    th.col-tgl, td.col-tgl { padding: 2px 4px; }

    .col-amount { width: 17%; white-space: nowrap; }

    .summary-box {
      background: none; /* tanpa background */
      padding: 8px 10px;
      margin: 6px 10px 10px;
      border-radius: 16px;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid var(--emas);
    }

    .summary-box span {
      font-size: 15px;
      font-weight: 700;
    }

    #saldo {
      font-size: 16px;
      font-weight: 800;
      text-shadow: black;
    }

    #emptyState {
      text-align:center;
      padding:10px;
      color:#6b7280;
      font-size:12px;
      opacity: 0.9;
    }

    /* Tombol Sinkron transparan + glossy */
    #btnSinkron {
      background: none;
      color: #111827;
      border-radius: 12px;
      border: 2px solid var(--emas);
      padding: 7px 18px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      white-space: nowrap;
    }

    #btnSinkron:hover {
      transform: translateY(-1px);
      background: rgba(250,250,250,0.4);
    }

    #btnSinkron:active {
      transform: translateY(1px);
      background: rgba(248,250,252,0.8);
    }
  </style>
</head>
<body>

<div id="appBox" class="app-container pad-input">

  <div id="rekapTitle" class="rekap-title">Rekap BIOP</div>

  <!-- ================= HALAMAN INPUT ================= -->
  <section id="page-input" class="page active">

    <div class="form-group form-row">
      <label for="tanggal">Tanggal</label>
      <input type="date" id="tanggal">
    </div>

    <div class="form-group form-row">
      <label for="keterangan">Keterangan</label>
      <input type="text" id="keterangan" placeholder="">
    </div>

    <div class="form-group">
      <div class="amount-wrapper">
        <div class="amount-field" id="fieldMasuk">
          <label for="masuk">Masuk</label>
          <input type="tel" id="masuk" placeholder="" inputmode="numeric">
        </div>
        <div class="amount-field" id="fieldKeluar">
          <label for="keluar">Keluar</label>
          <input type="tel" id="keluar" placeholder="" inputmode="numeric">
        </div>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-primary" id="btnSimpan">Simpan</button>
      <button class="btn btn-secondary" id="btnLihatLaporan">Lihat</button>
    </div>

  </section>

  <!-- ================= HALAMAN LAPORAN ================= -->
  <section id="page-report" class="page">

    <button id="btnKembali" class="btn-back-page">REKAP BIOP PJ BATUR</button>

    <div class="summary-box">
      <span>Saldo: <span id="saldo">Rp 0</span></span>
      <button id="btnSinkron">üîÅ</button>
    </div>

    <div style="padding:0px; margin-top:2px;">
      <table>
        <colgroup>
          <col class="col-tgl">
          <col>
          <col class="col-amount">
          <col class="col-amount">
          <col class="col-amount">
        </colgroup>
        <thead>
          <tr>
            <th class="col-tgl">Tgl</th>
            <th>Keterangan</th>
            <th class="text-center">Masuk</th>
            <th class="text-center">Keluar</th>
            <th class="text-center">Saldo</th>
          </tr>
        </thead>
        <tbody id="tbodyLaporan"></tbody>
      </table>
    </div>

    <div id="emptyState">Belum ada data.</div>

  </section>

</div>

<script>
let transaksi = [];

/* Konstanta GitHub */
const GITHUB_OWNER    = "zaidhidayat";
const GITHUB_REPO     = "bbm";
const GITHUB_FILEPATH = "bbmbatur.csv";
const GITHUB_API_URL  = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILEPATH}`;

/* FORMAT ANGKA */
function formatRibuan(num){
  if(!num && num !== 0) return "0";
  return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g,".");
}
function toNumber(str){ return parseInt(str.replace(/\./g,"")) || 0; }
function formatRupiah(n){ return "Rp " + formatRibuan(n); }

/* NAV */
function showPage(id){
  document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

const appBox = document.getElementById("appBox");
const rekapTitle = document.getElementById("rekapTitle");
const tanggal = document.getElementById("tanggal");
const keterangan = document.getElementById("keterangan");
const masuk = document.getElementById("masuk");
const keluar = document.getElementById("keluar");
const fieldMasuk = document.getElementById("fieldMasuk");
const fieldKeluar = document.getElementById("fieldKeluar");

function showBothFields(){
  fieldMasuk.style.display = "block";
  fieldKeluar.style.display = "block";
}

/* Tanggal hari ini */
(function(){
  const t = new Date();
  tanggal.value = t.toISOString().split("T")[0];
})();

/* Format input ribuan */
function aktifkanFormat(el){
  el.addEventListener("input", ()=>{
    let v = el.value.replace(/\./g,"");
    if(!/^\d*$/.test(v)) return;
    el.value = formatRibuan(v);
  });
}
aktifkanFormat(masuk);
aktifkanFormat(keluar);

/* Sembunyikan field lawan */
masuk.addEventListener("focus", ()=> fieldKeluar.style.display="none");
keluar.addEventListener("focus", ()=> fieldMasuk.style.display="none");

function resetVis(){
  if(masuk.value==="" && keluar.value===""){
    showBothFields();
  }
}
masuk.addEventListener("input", resetVis);
keluar.addEventListener("input", resetVis);

/* Kembalikan dua field jika kosong + backspace */
masuk.addEventListener("keydown", (e)=>{
  if((e.key === "Backspace" || e.key === "Delete") && masuk.value === ""){
    showBothFields();
  }
});
keluar.addEventListener("keydown", (e)=>{
  if((e.key === "Backspace" || e.key === "Delete") && keluar.value === ""){
    showBothFields();
  }
});

/* Load localStorage */
if(localStorage.getItem("transaksi")){
  transaksi = JSON.parse(localStorage.getItem("transaksi"));
}

/* SIMPAN */
document.getElementById("btnSimpan").onclick = ()=>{
  const m = toNumber(masuk.value);
  const k = toNumber(keluar.value);

  if(!keterangan.value.trim() || (!m && !k)){
    alert("Lengkapi data.");
    return;
  }
  if(m > 0 && k > 0){
    alert("Hanya pilih Masuk atau Keluar.");
    return;
  }

  transaksi.push({
    tanggal: tanggal.value,
    keterangan: keterangan.value.trim(),
    masuk: m,
    keluar: k
  });

  localStorage.setItem("transaksi", JSON.stringify(transaksi));

  masuk.value="";
  keluar.value="";
  keterangan.value="";
  showBothFields();

  alert("Tersimpan.");
};

/* LAPORAN */
function renderLaporan(){
  const tbody = document.getElementById("tbodyLaporan");
  tbody.innerHTML = "";

  let saldo = 0;

  transaksi.forEach(t=>{
    saldo += t.masuk - t.keluar;

    const d = t.tanggal.split("-");
    const ddmm = `${d[2]}/${d[1]}`;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="col-tgl">${ddmm}</td>
      <td>${t.keterangan}</td>
      <td class="text-right">${t.masuk ? formatRibuan(t.masuk) : "-"}</td>
      <td class="text-right">${t.keluar ? formatRibuan(t.keluar) : "-"}</td>
      <td class="text-right">${formatRibuan(saldo)}</td>
    `;
    tbody.appendChild(tr);
  });

  const saldoEl = document.getElementById("saldo");
  saldoEl.textContent = formatRupiah(saldo);
  saldoEl.style.color = saldo < 0 ? "#b91c1c" : "#16a34a";

  document.getElementById("emptyState").style.display =
    transaksi.length===0 ? "block" : "none";
}

/* Generate CSV dari transaksi */
function generateCsvFromTransaksi(){
  let lines = ["tgl,keterangan,masuk,keluar,saldo"];
  let saldo = 0;

  transaksi.forEach(t => {
    saldo += t.masuk - t.keluar;
    const d = t.tanggal.split("-");
    const ddmm = `${d[2]}/${d[1]}`;

    const masukStr  = t.masuk  ? t.masuk  : "";
    const keluarStr = t.keluar ? t.keluar : "";
    const saldoStr  = saldo;

    const ket = (t.keterangan || "").replace(/,/g, " ");

    lines.push([ddmm, ket, masukStr, keluarStr, saldoStr].join(","));
  });

  return lines.join("\n");
}

/* Normalisasi teks CSV */
function normalizeCsvText(txt){
  return txt.replace(/\s+/g, "");
}

/* Ambil / minta GitHub token */
function getGithubToken(){
  let token = localStorage.getItem("githubToken");
  if(!token){
    token = prompt("Masukkan GitHub API token (dengan akses repo):", "");
    if(!token){
      alert("Token tidak diisi. Sinkron dibatalkan.");
      return null;
    }
    token = token.trim();
    localStorage.setItem("githubToken", token);
  }
  return token;
}

/* Decode base64 GitHub */
function decodeGithubContent(b64){
  const cleaned = b64.replace(/\n/g, "");
  try {
    return decodeURIComponent(escape(atob(cleaned)));
  } catch(e){
    return atob(cleaned);
  }
}

/* Encode ke base64 */
function encodeGithubContent(str){
  try {
    return btoa(unescape(encodeURIComponent(str)));
  } catch(e){
    return btoa(str);
  }
}

/* lihat laporan */
document.getElementById("btnLihatLaporan").onclick = ()=>{
  renderLaporan();
  appBox.className = "app-container pad-report";
  rekapTitle.style.display = "none";
  showPage("page-report");
};

/* kembali */
document.getElementById("btnKembali").onclick = ()=>{
  appBox.className = "app-container pad-input";
  rekapTitle.style.display = "block";
  showPage("page-input");
  showBothFields();
};

/* SINKRON ke GitHub */
document.getElementById("btnSinkron").onclick = async ()=>{
  if(transaksi.length === 0){
    alert("Tidak ada data untuk disinkronkan.");
    return;
  }

  const token = getGithubToken();
  if(!token) return;

  const localCsv = generateCsvFromTransaksi();

  try {
    const getResp = await fetch(GITHUB_API_URL, {
      headers: {
        "Authorization": "token " + token,
        "Accept": "application/vnd.github.v3+json"
      }
    });

    let remoteCsv = "";
    let sha = null;

    if(getResp.status === 200){
      const data = await getResp.json();
      sha = data.sha;
      if(data.content){
        remoteCsv = decodeGithubContent(data.content);
      }
    } else if(getResp.status === 404){
      // file belum ada
    } else if(!getResp.ok){
      throw new Error("Gagal mengambil data GitHub (status " + getResp.status + ")");
    }

    const same = normalizeCsvText(remoteCsv) === normalizeCsvText(localCsv);
    if(same){
      alert("Data sudah disimpan.");
      return;
    }

    const body = {
      message: "Update bbmbatur.csv via BIOP app",
      content: encodeGithubContent(localCsv)
    };
    if(sha){
      body.sha = sha;
    }

    const putResp = await fetch(GITHUB_API_URL, {
      method: "PUT",
      headers: {
        "Authorization": "token " + token,
        "Accept": "application/vnd.github.v3+json",
        "Content-Type": "application/json"
      },
      body: JSON.stringify(body)
    });

    if(!putResp.ok){
      if(putResp.status === 401 || putResp.status === 403){
        localStorage.removeItem("githubToken");
        alert("Gagal menyimpan ke GitHub (token mungkin salah / kadaluarsa). Silakan sinkron lagi dan masukkan token baru.");
      } else {
        throw new Error("Gagal menyimpan ke GitHub (status " + putResp.status + ")");
      }
      return;
    }

    alert("Data sudah disimpan.");

  } catch(err){
    console.error(err);
    alert("Gagal sinkron: " + err.message);
  }
};
</script>

</body>
</html>
